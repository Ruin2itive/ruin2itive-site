<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <style>
    .error-container {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #fee;
      border: 2px solid #c33;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      z-index: 10000;
      font-family: sans-serif;
    }
    .error-container.show {
      display: block;
    }
    .error-container h3 {
      margin-top: 0;
      color: #c33;
    }
    .error-container pre {
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .error-container button {
      margin-top: 10px;
      padding: 8px 16px;
      background: #c33;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .error-container button:hover {
      background: #a22;
    }
  </style>
</head>
<body>
  <div id="error-container" class="error-container">
    <h3>⚠️ Authentication Error</h3>
    <div id="error-message"></div>
    <button onclick="location.reload()">Reload Page</button>
  </div>
  
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js"></script>
  
  <script>
    // Enhanced error logging for debugging
    window.addEventListener('error', function(event) {
      console.error('Global error:', event.error);
      showError('JavaScript Error', event.error ? event.error.message : 'Unknown error occurred');
    });

    // Listen for CMS errors
    if (window.CMS) {
      window.CMS.registerEventListener({
        name: 'error',
        handler: ({ data }) => {
          console.error('CMS Error:', data);
          const message = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
          showError('CMS Error', message);
        }
      });
    }

    // Check for authentication errors in URL hash
    window.addEventListener('load', function() {
      const hash = window.location.hash;
      if (hash.includes('error')) {
        const params = new URLSearchParams(hash.substring(1));
        const error = params.get('error');
        const errorDescription = params.get('error_description');
        if (error) {
          console.error('OAuth Error:', error, errorDescription);
          showError('OAuth Error', `${error}: ${errorDescription || 'No description provided'}`);
        }
      }
      
      // Log configuration for debugging
      fetch('/admin/config.yml')
        .then(r => r.text())
        .then(config => {
          console.log('CMS Configuration loaded successfully');
          console.log('Config preview:', config.substring(0, 200) + '...');
        })
        .catch(err => {
          console.error('Failed to load config.yml:', err);
          showError('Configuration Error', 'Failed to load admin/config.yml. Please ensure the file exists and is accessible.');
        });
    });

    function showError(title, message) {
      const container = document.getElementById('error-container');
      const messageDiv = document.getElementById('error-message');
      messageDiv.innerHTML = `<p><strong>${title}</strong></p><pre>${message}</pre>`;
      container.classList.add('show');
    }

    // Log successful CMS initialization
    console.log('%cNetlify CMS Admin Interface', 'font-size: 20px; font-weight: bold; color: #00ad9f;');
    console.log('Repository: Ruin2itive/ruin2itive-site');
    console.log('Branch: main');
    console.log('Backend: GitHub (requires repository write access)');
    console.log('%cFor authentication to work, you must:', 'font-weight: bold;');
    console.log('1. Have write access to the repository');
    console.log('2. Be logged into your GitHub account');
    console.log('3. Authorize the application when prompted');
  </script>
</body>
</html>
